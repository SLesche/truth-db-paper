---
editor_options:
  chunk_output_type: console
---
```{r data-analysis-setup}
library(tidyverse)
library(data.table)
library(lme4)
library(afex)
library(brms)
```

```{r}
full_data <- data.table::fread("markdown/data/full_data.csv")

analysis_data <- full_data %>% 
  filter(phase == "test") %>% 
  filter(!is.na(repeated), !is.na(response)) %>% 
  mutate(
    truth_instruction_timing = ifelse(
      truth_instruction_timing == "",
      "none",
      truth_instruction_timing
    ),
    repetition_instruction_timing = ifelse(
      repetition_instruction_timing == "",
      "none",
      repetition_instruction_timing
    ),
    repetition_time_type = case_when(
      repetition_time <= 5 ~ "immediate",
      repetition_time > 5 & repetition_time <= 60 ~ "delay",
      repetition_time > 60*24 ~ "next_day"
    )
  ) %>% 
  mutate(
    truth_instruction_timing = fct_relevel(
      factor(truth_instruction_timing),
      "none",
      "exposure", 
      "test",
      "both"
    ),
    repetition_instruction_timing = fct_relevel(
      factor(repetition_instruction_timing),
      "none",
      "exposure", 
      "test",
      "both"
    ),
    repetition_time_type = fct_relevel(
      factor(repetition_time_type),
      "immediate",
      "delay", 
      "next_day"
    ),
  )

has_complete_data <- analysis_data %>% 
  count(procedure_id, subject, repeated) %>% 
  count(procedure_id, subject) %>% 
  mutate(
    has_complete_data = ifelse(n == 2, 1, 0)
  )

analysis_data <- analysis_data %>% 
  left_join(
    ., has_complete_data
  ) %>% 
  filter(has_complete_data == 1) 

prop_true <- analysis_data %>% 
  group_by(statement_id) %>% 
  summarize(
    proportion_true = mean(response, na.rm = TRUE)
  )
  
analysis_data <- analysis_data %>% 
  left_join(prop_true)

dichotomous_data <- analysis_data %>% 
  filter(truth_rating_scale == "dichotomous")

scale_data <- analysis_data %>% 
  filter(truth_rating_scale != "dichotomous")
```

```{r}
model_check_dichotomous <- glmer(
  response ~ repeated + (1 | subject) + (1 | statement_id) + (1 | procedure_id),
  data = dichotomous_data,
  family = binomial()
)

summary(model_check_dichotomous)

model_re_dichotomous <- glmer(
  response ~ repeated + (1 + repeated | subject) + (1 + repeated | statement_id) + (1 + repeated | procedure_id),
  data = dichotomous_data,
  family = binomial()
)

summary(model_re_dichotomous)

model_check_likert <- lmer(
  response ~ repeated + (1 | subject) + (1 | statement_id) + (1 | procedure_id),
  data = scale_data,
)

summary(model_check_likert)

model_re_likert <- lmer(
  response ~ repeated + (1 + repeated | subject) + (1 + repeated | statement_id) + (1 + repeated | procedure_id),
  data = scale_data,
  REML = FALSE
)

summary(model_re_likert)
```

```{r}

# Convert to factor (if not already)
scale_data$repeated <- factor(scale_data$repeated)
scale_data$statement_accuracy <- factor(scale_data$statement_accuracy)
scale_data$repetition_time_type <- factor(scale_data$repetition_time_type)
scale_data$truth_instruction_timing <- factor(scale_data$truth_instruction_timing)
scale_data$repetition_instruction_timing <- factor(scale_data$repetition_instruction_timing)

# Apply effect coding (sum-to-zero contrasts)
# contrasts(scale_data$statement_accuracy) <- contr.sum(length(levels(scale_data$statement_accuracy)))
contrasts(scale_data$repetition_time_type) <- contr.sum(length(levels(scale_data$repetition_time_type)))
contrasts(scale_data$truth_instruction_timing) <- contr.sum(length(levels(scale_data$truth_instruction_timing)))
contrasts(scale_data$repetition_instruction_timing) <- contr.sum(length(levels(scale_data$repetition_instruction_timing)))

model_full_dichotomous <- glmer(
  response ~ repeated + statement_accuracy + proportion_true + repetition_time_type:repeated + truth_instruction_timing:repeated + repetition_instruction_timing:repeated + truth_instruction_timing:statement_accuracy + (1 | subject),
  data = dichotomous_data,
  family = binomial()
)
summary(model_full_dichotomous)

performance::r2_nakagawa(model_full_dichotomous)
# 
# model_0_dichotomous <- glmer(
#   response ~ repeated + (1 | subject) + (1 | statement_id) + (1 | procedure_id),
#   data = dichotomous_data,
#   family = binomial()
# )

model_0_likert <- lmer(
  response ~ repeated + (1 | subject) + (1 | statement_id) + (1 | procedure_id),
  data = scale_data
)

model_full_likert <- lmer(
  response ~ repeated + statement_accuracy + proportion_true + repetition_time_type:repeated + truth_instruction_timing:repeated + repetition_instruction_timing:repeated + truth_instruction_timing:statement_accuracy + (1 | subject),
  data = scale_data
)

summary(model_0_likert)
summary(model_full_likert)

performance::r2_nakagawa(model_0_likert)

```

```{r}
bayesian_model <- brms::brm(
  response ~ repeated + (1 | subject) + (1 | statement_id) + (1 | procedure_id),
  data = scale_data
)

```
-

```{r, eval = FALSE}
prep_aov <- function(data){
  data %>% 
    group_by(subject, repeated) %>% 
    summarize(mean_resp = mean(response, na.rm = FALSE))
}

run_simple_aov <- function(data) {
  aov_ez(
    id = "subject",
    dv = "mean_resp",
    within = "repeated",
    data = data
  )
}

run_lme4 <- function(data){
  lme4::lmer(response ~ repeated + (1 | subject), data = data)
}

results <- analysis_data %>% 
  nest(.by = c(procedure_id, repetition_time, n_statements)) %>% 
  mutate(
    aov_data = map(data, prep_aov),
  )
  
results <- results %>% 
  mutate(
    n_trials = map_dbl(data, nrow),
    n_subjects = map_dbl(data, ~length(unique(.$subject))),
    aov_results = map(aov_data, run_simple_aov)
  )

results <- results %>% 
  mutate(
    eta_sq = map_dbl(aov_results, ~effectsize::eta_squared(.) %>% pull(Eta2_partial)),
    omega_sq = map_dbl(aov_results, ~effectsize::omega_squared(.) %>% pull(Omega2_partial))
  )

results <- results %>% 
  mutate(
    mlm = map(data, run_lme4)
  )

results$eta_sq %>% hist(breaks = 10)
results$omega_sq %>% hist()

procedure_data <- query_db(
  conn,
  list() %>% 
    add_argument(
      conn,
      "procedure_id",
      "greater",
      "0"
    ),
  "default",
  "procedure_table"
)
```


```{r, eval = FALSE}
effect_by_subject <- analysis_data %>% 
  group_by(subject, repeated, n_statements, repetition_time, truth_instructions, truth_instruction_timing, repetition_instruction_timing, repetition_instructions, procedure_id) %>% 
  summarize(
    mean_resp = mean(response, na.rm = TRUE)
  ) %>% 
  pivot_wider(
    names_from = "repeated",
    names_prefix = "repeated_",
    values_from = "mean_resp"
  ) %>% 
  mutate(
    effect = repeated_1 - repeated_0,
    combination = interaction(subject, procedure_id),
  ) %>% 
  ungroup()

effect_by_subject %>% 
  ggplot(
    aes(
      x = fct_reorder(combination, effect),
      y = effect,
    )
  )+
  geom_point()+
  geom_hline(yintercept = 0,
             col = "red")+
  labs(
    x = "Subject",
    y = "Truth Effect"
  )

effect_by_subject %>% 
  count(procedure_id, effect > 0) %>%
  pivot_wider(
    names_from = "effect > 0",
    values_from = n,
    names_prefix = "eff_present"
  ) %>% 
  mutate(
    n_subjects = eff_presentTRUE + eff_presentFALSE,
    percent_showing = eff_presentTRUE  / (eff_presentTRUE + eff_presentFALSE)
  ) %>% 
  pull(percent_showing) %>% 
  hist(breaks = 20)
```

