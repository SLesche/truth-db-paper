---
editor_options:
  chunk_output_type: console
---
```{r data-analysis-setup}
library(tidyverse)
library(data.table)
library(lme4)
# library(afex)
library(rstan)
library(brms)
library(sjPlot)
library(bayesplot)
library(extrafont)

compute_new = FALSE
```

```{r}
analysis_data <- full_data %>% 
  filter(phase == "test") %>% 
  filter(!is.na(repeated), !is.na(response)) %>% 
  mutate(
    truth_instruction_timing = ifelse(
      truth_instruction_timing == "",
      "none",
      truth_instruction_timing
    ),
    repetition_instruction_timing = ifelse(
      repetition_instruction_timing == "",
      "none",
      repetition_instruction_timing
    ),
    repetition_time_type = case_when(
      repetition_time <= 5 ~ "immediate",
      repetition_time > 5 & repetition_time <= 60 ~ "delay",
      repetition_time >= 60*24 ~ "next_day"
    )
  ) %>% 
  mutate(
    truth_instruction_timing = fct_relevel(
      factor(truth_instruction_timing),
      "none",
      "exposure", 
      "test",
      "both"
    ),
    repetition_instruction_timing = fct_relevel(
      factor(repetition_instruction_timing),
      "none",
      "exposure", 
      "test",
      "both"
    ),
    repetition_time_type = fct_relevel(
      factor(repetition_time_type),
      "immediate",
      "delay", 
      "next_day"
    ),
    repetition_sameday = ifelse(repetition_time < 60*24, 1, 0),
    repeated = repeated - 0.5
  )

has_complete_data <- analysis_data %>% 
  count(procedure_id, subject, repeated) %>% 
  count(procedure_id, subject) %>% 
  mutate(
    has_complete_data = ifelse(n == 2, 1, 0)
  )

analysis_data <- analysis_data %>% 
  left_join(
    ., has_complete_data
  ) %>% 
  filter(has_complete_data == 1) 

prop_true <- analysis_data %>% 
  group_by(statement_id) %>% 
  summarize(
    proportion_true = mean(response, na.rm = TRUE)
  )
  
analysis_data <- analysis_data %>% 
  left_join(prop_true)

dichotomous_data <- analysis_data %>% 
  filter(truth_rating_scale == "dichotomous")

scale_data <- analysis_data %>% 
  filter(truth_rating_scale != "dichotomous")
```

```{r}
# Number of participants, age, laboratory status, scale
long_study_data <- study_overview %>% 
  mutate_all(as.character) %>% 
  mutate(filler_task_type = case_when(
    filler_task_type == "" ~ "none",
    filler_task_type == 0 ~ "non-verbal",
    filler_task_type == 1 ~ "verbal",
    TRUE ~ filler_task_type
  )) %>% 
  mutate(
    filler_task_yesno = ifelse(filler_task_yesno == 1, "yes", "no"),
    student_sample = ifelse(is.na(student_sample), "NA", ifelse(student_sample == 1, "yes", "no"))
  ) %>% 
  select(student_sample, truth_rating_scale, truth_rating_steps, filler_task_yesno, filler_task_type) %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")

plot_study_data <- long_study_data %>%
  count(variable, value) %>% 
  mutate(
    value = fct_relevel(
      factor(value),
      "101", "range", "likert", "11", "7", "6", "5", "4", "dichotomous", "2", "none"
    )
  )

study_overview_plot <- ggplot(plot_study_data, aes(x = variable, y = n, fill = value)) +
  geom_bar(stat = "identity") +
  geom_text(
    aes(
      label = paste0(value, "\n(", n, ")")),
      # label = paste0(value, " (", n, ")")),
      position = position_stack(vjust = 0.5),
      color = "black",
      size = 10,
      fontface = "bold",
      lineheight = 0.8,
      # family = "Times New Roman"   # set Times New Roman for labels
  ) +
  labs(
    # title = "Breakdown of Study Variables",
    x = NULL,
    y = "Count"
  )+
  scale_fill_grey(start = 0.3, end = 0.9) +  # keep the contrast
  theme_minimal(base_size = 25) +  # larger base font size for all text
  theme(
    legend.position = "none",
  ) +
  coord_flip()

study_overview_plot

ggsave("markdown/images/study_overview_plot.png", study_overview_plot, width = 16, height = 9)


# Reshape data to long format
long_procedure_data <- procedure_data %>%
  filter(phase == "test") %>% 
  select(
    repetition_instructions, repetition_instruction_timing,
    truth_instructions, truth_instruction_timing,
    presentation_type, repetition_type, repetition_location,
    percent_repeated,
    exposure_task_truth
    ) %>%  # Add more vars if needed
  mutate_all(as.character) %>% 
  mutate(
    repetition_instructions = ifelse(
      repetition_instructions == "1", "yes", "no"
    ),
    exposure_task_truth = ifelse(
      exposure_task_truth == 1, "yes", "no"
    ),
    repetition_instruction_timing = ifelse(
      repetition_instruction_timing == "",
      "none", repetition_instruction_timing
    ),
    truth_instructions = ifelse(
      truth_instructions == "1", "yes", "no"
    ),
    truth_instruction_timing = ifelse(
      truth_instruction_timing == "",
      "none", truth_instruction_timing
    ),
    percent_repeated = case_when(
      percent_repeated %in% c("66", "67", "66.67") ~ "66",
      TRUE ~percent_repeated
    ),
    repetition_type = ifelse(repetition_type == "some exact, some semantic (incongruent)", "mixed", repetition_type)
  ) %>% 
  mutate(
    repetition_instruction_timing = ifelse(
      repetition_instruction_timing == "test",
      "judgment", repetition_instruction_timing
    ),
    truth_instruction_timing = ifelse(
      truth_instruction_timing == "test",
      "judgment", truth_instruction_timing
    ),
  ) %>% 
  mutate(
    truth_instruction_timing = fct_relevel(
      factor(truth_instruction_timing),
      "both", "exposure", "test", "none"
    ),
    repetition_instruction_timing = fct_relevel(
      factor(repetition_instruction_timing),
      "both", "exposure", "test", "none"
    )
  ) %>% 
  mutate(
    percent_repeated = paste0(percent_repeated, " %")
  ) %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")

# Count combinations of variable and value
plot_procedure_data <- long_procedure_data %>%
  count(variable, value) %>% 
  mutate(
    value = fct_relevel(
      factor(value),
      "paraphrase", "exact","no", "none", "yes", "judgment", "exposure", "both",
      "100 %", "67 %", "66.67 %", "66 %", "50 %", "46.67 %", "33 %", "0", "mixed"
    )
  )

# Plot
procedure_overview_plot <- ggplot(plot_procedure_data, aes(x = variable, y = n, fill = value)) +
  geom_bar(stat = "identity") +
  geom_text(
    aes(label = paste0(value, "\n(", n, ")")),
    position = position_stack(vjust = 0.5),
    color = "black",
    size = 9,
    lineheight = 0.8,
    fontface = "bold"
  ) +
  labs(
    # title = "Breakdown of Procedure Variables",
    x = NULL,
    y = "Count"
  ) +
  scale_fill_grey(start = 0.4, end = 0.9) +  # keep the contrast
  theme_minimal(base_size = 25) +  # larger base font size for all text
  theme(
    legend.position = "none",
  ) +
  coord_flip()

procedure_overview_plot

ggsave("markdown/images/procedure_overview_plot.png", procedure_overview_plot, width = 24, height = 9)
```

```{r, eval = FALSE}
# Split into short and long delays
df_short <- procedure_data %>%
  filter(repetition_time <= 1440) %>%
  mutate(delay_minutes = repetition_time)

df_long <-procedure_data %>%
  filter(repetition_time > 1440) %>%
  mutate(delay_days = repetition_time / 1440)

# Plot 1: Short delays (in minutes)
p1 <- ggplot(df_short, aes(x = delay_minutes)) +
  geom_histogram(binwidth = 2, fill = "steelblue", color = "white", alpha = 0.8) +
  scale_x_continuous(name = "Delay (minutes)") +
  labs(title = "Short Delays (< 1d)", y = "Count") +
  theme_minimal()

# Plot 2: Long delays (in days)
p2 <- ggplot(df_long, aes(x = delay_days)) +
  geom_histogram(binwidth = 1, fill = "darkgreen", color = "white", alpha = 0.8) +
  scale_x_continuous(name = "Delay (days)") +
  labs(title = "Long Delays (> 1d)", y = "Count") +
  theme_minimal()

delay_plot <- gridExtra::grid.arrange(p1, p2, ncol = 2)

```

```{r}
if (compute_new == TRUE){
  
  library(brms)
  options(mc.cores = parallel::detectCores())

  model_full_dichotomous_bayes = brms::brm(
    response ~ repeated + (1 + repeated || subject) + (1 + repeated || statement_id) + (1 + repeated || procedure_id),
    data = dichotomous_data,
    family = brms::bernoulli(),
    prior =  c(
      prior(normal(0, 1), class = "b"),
      prior(gamma(1, 4), class = "sd"),
      prior(normal(0.5, 0.5), class = "Intercept")
    ),
    backend = "cmdstanr",
    chains = 4,
    cores = 4,
    threads = threading(threads = 2),
    control = list(adapt_delta = 0.90),
    warmup = 1000,
    iter = 3000,
    file = "./markdown/data/bayes_model_dichotomous"
  )
  
  model_full_scale_bayes = brms::brm(
    response ~ repeated + (1 + repeated || subject) + (1 + repeated || statement_id) + (1 + repeated || procedure_id),
    data = scale_data,
    backend = "cmdstanr",
    prior =  c(
      prior(normal(0, 1), class = "b"),
      prior(gamma(1, 4), class = "sd"),
      prior(normal(0.5, 0.5), class = "Intercept")
    ),
    chains = 4,
    cores = 4,
    threads = threading(threads = 4),
    control = list(adapt_delta = 0.90),
    warmup = 1000,
    iter = 3000,
    file = "./markdown/data/bayes_model_scale"
  )
  
  model_time_scale_bayes = brms::brm(
    response ~ repeated + (1 + repeated || subject:repetition_sameday) + (1 + repeated || statement_id) + (1 + repeated || procedure_id),
    data = scale_data,
    backend = "cmdstanr",
    prior =  c(
      prior(normal(0, 1), class = "b"),
      prior(gamma(1, 4), class = "sd"),
      prior(normal(0.5, 0.5), class = "Intercept")
    ),
    chains = 4,
    cores = 4,
    threads = threading(threads = 4),
    control = list(adapt_delta = 0.90),
    warmup = 1000,
    iter = 3000,
    file = "./markdown/data/bayes_model_scale_time"
  )
} else {
  model_full_dichotomous_bayes <- readRDS("./markdown/data/bayes_model_dichotomous.rds")
  model_full_scale_bayes <- readRDS("./markdown/data/bayes_model_scale.rds")
  model_time_scale_bayes <- readRDS("./markdown/data/bayes_model_scale_time.rds")
}

summary_model_full_dichotomous_bayes <- summary(model_full_dichotomous_bayes)
summary_model_full_scale_bayes <- summary(model_full_scale_bayes)
summary_model_time_scale_bayes <- summary(model_time_scale_bayes)

main_eff_dich <- hypothesis(model_full_dichotomous_bayes, "repeated > 0")
main_eff_scale <- hypothesis(model_full_scale_bayes, "repeated > 0")
main_eff_time <- hypothesis(model_time_scale_bayes, "repeated > 0")

# From LuSchumacher https://github.com/LuSchumacher/truth_ddm/blob/main/src/4_model_evaluation.R
calc_BF <- function(posterior_samples, prior_sd = 0.5) {
  post_density <- density(posterior_samples, bw = "nrd0")
  posterior_at_zero <- approx(post_density$x, post_density$y, xout = 0)$y
  if(is.na(posterior_at_zero) || posterior_at_zero < 1e-10) {
    posterior_at_zero <- 1e-10
  }
  prior_at_zero <- dnorm(0, mean = 0, sd = prior_sd)
  BF10 <- prior_at_zero / posterior_at_zero
  return(BF10)
}

compute_BFs <- function(fit, param_names, prior_sd = 0.5) {
  sapply(param_names, function(param) {
    samples <- as.numeric(fit$draws(param))
    calc_BF(samples, prior_sd)
  })
}

calc_BF(as_draws_matrix(model_full_dichotomous_bayes, "b_repeated"), 1)
calc_BF(as_draws_matrix(model_full_scale_bayes, "b_repeated"), 1)
calc_BF(as_draws_matrix(model_time_scale_bayes, "b_repeated"), 1)

```

```{r}
library(posterior)

# Get random slopes from the fitted model
re <- ranef(model_time_scale_bayes, summary = FALSE)$`subject:repetition_sameday`
slopes <- re[, , "repeated"]
intercept <- re[, , "Intercept"]

# Identify grouping levels
group_labels <- dimnames(re)[[2]]
rep_vals <- as.integer(gsub(".*_", "", group_labels))  # extract 0 or 1 from subject:0 or subject:1

# Separate by condition
slopes_0 <- slopes[, rep_vals == 0]
slopes_1 <- slopes[, rep_vals == 1]

intercept_0 <- apply(intercept[, rep_vals == 0], 1, sd)
intercept_1 <- apply(intercept[, rep_vals == 1], 1, sd)

# Get posterior SD of slopes per condition
sd_0 <- apply(slopes_0, 1, sd)
sd_1 <- apply(slopes_1, 1, sd)
sd_diff <- sd_1 - sd_0

posterior_prob <- mean(sd_diff > 0)
```

